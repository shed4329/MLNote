# Project: 人脸检测

## 项目简介

本项目旨在构建一个能够识别图像中是否含有人脸的分类模型。通过对 WIDER FACE 数据集进行处理、训练卷积神经网络模型，实现对输入图像进行人脸概率预测，并判断图像是否为人脸图像。

## 数据集
本次使用的是香港中文大学(CUHK)的WIDER FACE数据集。可以在[hugging face](https://huggingface.co/datasets/CUHK-CSE/wider_face "WIDER FACE")上查看数据集

WIDER FACE 数据集以 “事件” 为核心组织，涵盖了现实生活中多种场景下的人脸图像，具体特点如下：

- 场景多样性：包含 10 个主要场景类别（如 “婚礼”“游行”“海滩”“街道” 等），每个场景下又细分多个子场景，覆盖了不同光照（强光、逆光、弱光）、姿态（正面、侧面、倾斜）、遮挡（部分遮挡、严重遮挡）和分辨率（高、中、低）的人脸情况。
- 数据规模：原始数据集包含 32,203 张图像，标注了 393,703 个人脸框，其中训练集 28,823 张图像（353,723 个人脸），验证集 3,380 张图像（39,980 个人脸），数据量充足且分布广泛。
- 标注信息：每张图像的标注文件（如wider_face_train_bbx_gt.txt）包含图像路径、人脸数量及每个人脸的边界框（x1, y1, w, h），同时标注了人脸的遮挡程度、姿态等属性，为本项目提取人脸区域提供了精准依据。

**本项目对数据集的处理**


1. 人脸区域提取：根据标注文件中的边界框，从原始图像中裁剪出人脸区域，经尺寸调整（CPU 版本为 64×64，GPU 版本为 128×128）和颜色空间转换（BGR 转 RGB）后，保存为训练用的 “人脸样本”。
2. 非人脸区域提取：从不含人脸的图像区域或人脸区域外的背景中随机裁剪非人脸区域，同样调整尺寸后作为 “非人脸样本”，并通过限制最大数量平衡两类样本比例。
3. 数据清洗：过滤过小的人脸区域（如小于 32×32 像素）、空图像或损坏文件，确保输入模型的样本有效性。

## 文件结构
```
face_detection_CNN
├── code                                        代码文件夹
│   ├── face_classifier_10k                       已经训练好的模型
│   ├── pic                                       用户要进行人脸检测的图片文件夹（支持jpg、jpeg、png格式）        
│   ├── Application.py                            应用程序,进行人脸检测  
│   ├── pre_processor_cpu.py                      使用CPU提取WIDER FACE数据集中的人脸图片(使用OpenCV)
│   ├── pre_processor_cpu.py                      使用GPU提取WIDER FACE数据集中的人脸图片(使用tensorflow和OpenCV)
│   ├── report.txt                                模型训练报告
│   ├── test_gpu_support.py                       测试当前版本的tensorflow是否支持GPU加速
│   ├── Training.py                               模型训练程序
├── dataset                                     WIDER FACE数据集
│   ├── wider_face_split
│   ├── WIDER_test
│   ├── WIDER_train
├── processed                                   处理后的数据集
│   ├── train                                     训练集
│   │   ├── face                                    人脸样本
│   │   ├── not_face                                非人脸样本
│   ├── val                                       测试集
│       ├── face                                    人脸样本
│       ├── not_face                                非人脸样本
├── README.md                                   项目说明文档
```
## 环境
我的运行环境为
```
系统:Windows 11 24H2(build 26100.4946)
CPU:AMD Ryzen 7 8845H w/ Radeon 780M Graphics
GPU:NVIDIA GeForce RTX 4060 Laptop GPU
     Driver Version: 555.97         
     CUDA Version: 12.5 (最高支持12.5版本CUDA)
     Build cuda_11.2.r11.2/compiler.29373293_0(安装了11.2版本的CUDA)
     cudnn 8.1.1
tensorflow:2.10.1
python:3.10.0
numpy:1.23.5
```

## 使用方法
### （一）数据集预处理
CPU 版本：
```bash
python pre_precessor_cpu.py
```
处理后的数据保存至../processed/train/face（人脸）和../processed/train/not_face（非人脸）。
GPU 版本：
```bash
python pre_processor_gpu.py
```
需确保 GPU 环境配置正确，处理效率更高，输出尺寸为 128×128。
### （二）模型训练
```bash
python Training.py
```
脚本会加载预处理数据，构建包含 3 个卷积层和 2 个全连接层的模型，使用数据增强（随机翻转、亮度 / 对比度调整）提升泛化能力，训练完成后保存模型至face_classifier_10k，并生成report.txt。
### （三）模型预测
将待预测图片放入pic目录。
运行预测脚本：
```bash
python Application.py
```
脚本会输出每张图片的 “人脸概率” 及判断结果（概率 > 50% 视为人脸）。
## 训练结果
数据集规模：总样本 145,533 张（训练集 116,426 张，验证集 29,107 张）。
训练指标

|轮次	|训练损失	|训练准确率	|验证损失	|验证准确率|
|-------|-------|-------|-------|-------|
|1	|0.064056	|0.978484	|0.036733	|0.987838|
|2	|0.035957	|0.988894	|0.029715	|0.990724|
|3	|0.029930	|0.990655	|0.023502	|0.993026|
|4	|0.026570	|0.991703	|0.029932	|0.990758|

最佳结果：第 3 轮验证准确率达 99.30%，表明模型对人脸和非人脸的分类能力较强。
## 项目不足之处
### 数据集局限性：
非人脸区域通过随机裁剪生成，可能不包含与人脸特征相似的区域（如动物面部），影响模型判别能力。
### 预处理效率与一致性问题：
CPU 版本预处理速度较慢，面对大规模数据时耗时较长；GPU 版本虽高效，但依赖硬件配置，且与 CPU 版本输出尺寸（64×64 vs 128×128）不一致，可能影响模型复用。
### 预测逻辑单一：
预测时采用固定阈值（50%）判断是否为人脸，未考虑不同应用场景的需求（如安防场景需更高召回率，可降低阈值减少漏检）。
### 未处理类别不平衡潜在风险：
虽通过限制非人脸样本数量平衡比例，但原始数据中人脸与非人脸的真实分布可能与训练集存在差异，可能导致模型在实际场景中偏向多数类。
